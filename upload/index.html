<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="neonll">
    <title>ZPB30A1 Remote</title>

    <!-- Bootstrap core CSS -->
    <link href="bootstrap.min.css" rel="stylesheet">

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>

    
    <!-- Custom styles for this template -->
    <link href="remote.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="jquery.bootstrap-touchspin.min.css">
  </head>
  <body>
    
<nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
  <a class="navbar-brand col-md-3 col-lg-2 mr-0 px-3" href="#">ZPB30A1 Remote</a>
  <div class="row">
    <div class="col">
      <button class="btn btn-sm btn-light btn-outline-success" id="btn_loadOn">
        <i class="bi bi-play-fill"></i>
      </button>
    </div>
    <div class="col">
      <button class="btn btn-sm btn-light btn-outline-danger" id="btn_loadOff">
        <i class="bi bi-stop-fill"></i>
      </button>
    </div>
  </div>
  <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-toggle="collapse" data-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
<!--  <input class="form-control form-control-dark w-100" type="text" placeholder="Search" aria-label="Search">-->
  <ul class="navbar-nav px-3">
    <li class="nav-item text-light text-nowrap">
<!--      <a class="nav-link" href="#">Sign out</a>-->
      <div class="row">
        <div class="col">
          <strong>Режим: </strong>
          <span id="span_set_mode">--</span>
        </div>
        <div class="col">
          <strong>Установка: </strong>
          <span id="span_set_setpoint">---</span>
        </div>
        <div class="col">
          <strong>Отсечка: </strong>
          <span id="span_set_cutoff">---</span>
        </div>
        <div class="col">
          <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#settingsModal">
            Настройки
          </button>
        </div>
      </div>
    </li>
  </ul>
</nav>

<div class="container-fluid">
  <div class="row">
    <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <div class="position-sticky pt-3">

        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
          <span>Логи</span>
          <a class="link-secondary" href="javascript:;" id="btn_load_logs_list" aria-label="Обновить">
            <i class="bi bi-arrow-repeat"></i>
          </a>
        </h6>
        <ul class="nav flex-column mb-2" id="ul_logs">
<!--          <li class="nav-item">-->
<!--            <a class="nav-link" href="#">-->
<!--              Current month-->
<!--            </a>-->
<!--          </li>-->
        </ul>
      </div>
    </nav>

    <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4">
      <h5 class="d-inline-block text-nowrap">
        <div class="row mt-2">
          <div class="col"><strong class="text-capitalize" id="span_point_isActive">---</strong></div>
          <div class="col">V: <strong id="span_point_vS">-</strong> В</div>
          <div class="col">Ач: <strong id="span_point_Ah">-</strong></div>
          <div class="col">Вт ч: <strong id="span_point_Wh">-</strong></div>
        </div>
        <div class="row mt-2">
          <div class="col">I: <span id="span_point_iSet">-</span> А</div>
          <div class="col">Темп.: <span id="span_point_temp">-</span> &#176;C</div>
          <div class="col">V питания: <span id="span_point_v12">-</span> В</div>

        </div>
      </h5>


      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h4">Лог</h1>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="check_chart_vS" checked="checked">
          <label class="form-check-label" for="check_chart_vS">
            Напряжение
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="check_chart_temp">
          <label class="form-check-label" for="check_chart_temp">
            Температура
          </label>
        </div>
        <div class="btn-toolbar mb-2 mb-md-0">
          <button type="button" class="btn btn-sm btn-outline-secondary mr-2" id="btn_log_clear">Очистить</button>
<!--          <div class="btn-group mr-2">-->
<!--            <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>-->
<!--            <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>-->
<!--          </div>-->
<!--          <div class="btn-group mr-2">-->
<!--            <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>-->
<!--            <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>-->
<!--          </div>-->
        </div>
      </div>


      <div id="chartdiv" class="my-4 w-100"></div>

      <!--    <canvas class="my-4 w-100" id="myChart" width="900" height="380"></canvas>-->
    </main>
  </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1" role="dialog" aria-labelledby="settingsModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="settingsModalLabel">Настройки</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form action="javascript:;">
          <div class="form-group row">
            <label for="inputMode" class="col-sm-2 col-form-label">Режим</label>
            <div class="col-sm-10">
              <select id="inputMode" class="form-control form-control-sm">
                <option value="CC">Пост. ток</option>
                <option value="CR">Пост. сопротивление</option>
                <option value="CV">Пост. напряжение</option>
                <option value="CP">Пост. мощность</option>
              </select>
            </div>
          </div>

          <div id="divI" class="form-group row divConst">
            <label for="inputI" class="col-sm-2 col-form-label">Ток</label>
            <div class="col-sm-10">
              <input type="text" id="inputI" data-val="I" class="form-control form-control-sm input-sm inputVal">
            </div>
          </div>

          <div id="divV" class="form-group row divConst d-none">
            <label for="inputV" class="col-sm-2 col-form-label">Напряжение</label>
            <div class="col-sm-10">
              <input type="text" id="inputV" data-val="V" class="form-control form-control-sm input-sm inputVal">
            </div>
          </div>

          <div id="divR" class="form-group row divConst d-none">
            <label for="inputR" class="col-sm-2 col-form-label">Сопротивление</label>
            <div class="col-sm-10">
              <input type="text" id="inputR" data-val="R" class="form-control form-control-sm input-sm inputVal">
            </div>
          </div>

          <div id="divP" class="form-group row divConst d-none">
            <label for="inputP" class="col-sm-2 col-form-label">Мощность</label>
            <div class="col-sm-10">
              <input type="text" id="inputP" data-val="P" class="form-control form-control-sm input-sm inputVal">
            </div>
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" value="" id="checkCutoff">
            <label class="form-check-label" for="checkCutoff">
              Отсечка по напряжению
            </label>
          </div>

          <div id="divCutoff" class="form-group row d-none">
            <label for="inputCutoff" class="col-sm-2 col-form-label">Напряжение</label>
            <div class="col-sm-10">
              <input type="text" id="inputCutoff" class="form-control form-control-sm input-sm">
            </div>
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" value="" id="checkBeep">
            <label class="form-check-label" for="checkBeep">
              Бипер
            </label>
          </div>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="checkPLimit">
            <label class="form-check-label" for="checkPLimit">
              Ограничивать мощность
            </label>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
<!--        <button type="button" class="btn btn-primary">Save changes</button>-->
      </div>
    </div>
  </div>
</div>

<!--<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>-->
<script>window.$ || document.write('<script src="./jquery.min.js"><\/script>')</script>
<script src="./bootstrap.bundle.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script src="moment.min.js"></script>
<script src="jquery.bootstrap-touchspin.min.js"></script>

<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>

<script>
  let Settings = {};
  let Point = {};
  let chart;
  let lastLog;
  let seriesVs;
  let seriesTemp;

  $('#btn_load_logs_list').click(function () {
    $.get("/getLogs", function(data) {
      // console.log(data);

      const files = data.split(',');
      // let logs = [];

      const $ulLogs = $('#ul_logs');
      $ulLogs.empty();

      $.each(files, function (i, v) {
        if (v) {
          const date = moment(parseInt(v.replace(/[^0-9.]/g, ""))*1000).format('DD.MM.YY HH:mm');
          // logs[i] = {'url': v, 'date': date};
          $ulLogs.append('<li class="nav-item"><a class="nav-link a_log" href="javascript:;" data-path="'+v+'">'+date+'</a></li>');
          lastLog = v;
        }
      })

      if (!chart)
        chartInit(lastLog);

      $('.a_log').click(function () {
        const path = $(this).data('path');
        chart.dataSource.url = path;
        chart.dataSource.load();
        })

    })
  })

  $('#btn_load_logs_list').trigger('click');

  $('#btn_log_clear').click(function () {
    chart.data = [];
  })

  $('#check_chart_vS').change(function () {
    if ($(this).is( ":checked" )) {
      seriesVs.show();
    }
    else {
      seriesVs.hide();
    }
  })

  $('#check_chart_temp').change(function () {
    if ($(this).is( ":checked" )) {
      seriesTemp.show();
    }
    else {
      seriesTemp.hide();
    }
  })

  $("#inputI").TouchSpin({
    min: 0.2,
    max: 10,
    step: 0.01,
    decimals: 2,
    boostat: 5,
    maxboostedstep: 10,
    postfix: 'А'
  });

  $("#inputV").TouchSpin({
    min: 0.5,
    max: 30,
    step: 0.01,
    decimals: 2,
    boostat: 5,
    maxboostedstep: 10,
    postfix: 'В'
  });

  $("#inputR").TouchSpin({
    min: 0.01,
    max: 15,
    step: 0.01,
    decimals: 2,
    boostat: 5,
    maxboostedstep: 10,
    postfix: 'Ом'
  });

  $("#inputP").TouchSpin({
    min: 0,
    max: 60,
    step: 0.01,
    decimals: 2,
    boostat: 5,
    maxboostedstep: 10,
    postfix: 'Вт'
  });

  $("#inputCutoff").TouchSpin({
    min: 0.5,
    max: 30,
    step: 0.01,
    decimals: 2,
    boostat: 5,
    maxboostedstep: 10,
    postfix: 'В'
  });

  function showConstDivs(mode) {
    $('.divConst').addClass('d-none');

    switch (mode) {
      case 'CC':
        $('#divI').removeClass('d-none');
        break;
      case 'CR':
        $('#divR').removeClass('d-none');
        break;
      case 'CV':
        $('#divV').removeClass('d-none');
        break;
      case 'CP':
        $('#divP').removeClass('d-none');
        break;
    }
  }

  $('#inputMode').change(function () {
    const mode = $(this).val();

    $.get("/setMode?mode="+mode, function(data) {
      console.log('Change mode: ' + data);

      showConstDivs(mode);
    })
  })

  let wto;

  $('.inputVal').change(function() {
    const val = $(this).val();
    const type = $(this).data('val');

    clearTimeout(wto);
    wto = setTimeout(function() {
      $.get("/setVal?type="+type+"&val="+val*1000, function(data) {
        console.log('SET' + type + ': ' + data);
      })
    }, 500);
  });

  $('#checkCutoff').change(function () {
    if ($(this).prop('checked')) {
      $('#divCutoff').removeClass('d-none');

      const val = $('#inputCutoff').val();

      if (val !== undefined) {
        clearTimeout(wto);
        wto = setTimeout(function() {
          $.get("/setCutoff?val="+val*1000, function(data) {
            console.log('SETCUTOFF: ' + data);
          })
        }, 500);
      }
    }
    else {
      $('#divCutoff').addClass('d-none');

      clearTimeout(wto);
      wto = setTimeout(function() {
        $.get("/setCutoff?val=OFF", function(data) {
          console.log('SETCUTOFF: ' + data);
        })
      }, 500);
    }
  })

  $('#inputCutoff').change(function () {
    const val = $(this).val();

    clearTimeout(wto);
    wto = setTimeout(function() {
      $.get("/setCutoff?val="+val*1000, function(data) {
        console.log('SETCUTOFF: ' + data);
      })
    }, 500);
  })

  $('#checkBeep').change(function () {
    let val;

    if ($(this).is( ":checked" )) {
      val = 'ON';
    }
    else {
      val = 'OFF';
    }

    clearTimeout(wto);
    wto = setTimeout(function() {
      $.get("/setBeep?val="+val, function(data) {
        console.log('SETBEEP: ' + data);
      })
    }, 500);
  })

  $('#checkPLimit').change(function () {
    let val;

    if ($(this).is( ":checked" )) {
      val = 'LIMIT';
    }
    else {
      val = 'NOLIMIT';
    }

    clearTimeout(wto);
    wto = setTimeout(function() {
      $.get("/setPLimit?val="+val, function(data) {
        console.log('SETPLIMIT: ' + data);
      })
    }, 500);
  })


  function loadSettings() {
    $.get( "/getState", function( data ) {
      // console.log(data);

      Settings = data.settings;
      Point = data.point;

      let modeText;
      let setpointDim;

      let setpoint = Settings.setpoint/1000;

      switch (Settings.mode) {
        case "CC":
          modeText = "Пост. ток";
          setpointDim = "А";
          if ($('#inputMode').val() != 'CC') {
            $('#inputMode').val('CC');
            showConstDivs('CC');
          }
          if (!$('#inputI').is(":visible"))
            $('#inputI').val(setpoint);
          break;
        case "CR":
          modeText = "Пост. сопр.";
          setpointDim = "Ом";
          if ($('#inputMode').val() != 'CR') {
            $('#inputMode').val('CR');
            showConstDivs('CR');
          }
          if (!$('#inputR').is(":visible"))
            $('#inputR').val(setpoint);
          break;
        case "CV":
          modeText = "Пост. напр.";
          setpointDim = "В";
          if ($('#inputMode').val() != 'CV') {
            $('#inputMode').val('CV');
            showConstDivs('CV');
          }
          if (!$('#inputV').is(":visible"))
            $('#inputV').val(setpoint);
          break;
        case "CW":
          modeText = "Пост. мощность";
          setpointDim = "Вт";
          if ($('#inputMode').val() != 'CP') {
            $('#inputMode').val('CP');
            showConstDivs('CP');
          }
          if (!$('#inputP').is(":visible"))
            $('#inputP').val(setpoint);
          break;
        default:
          modeText = '---';
          setpointDim = '--';
          break;
      }

      $('#span_set_mode').text(modeText);
      $('#span_set_setpoint').text(setpoint + ' ' + setpointDim);
      $('#span_set_cutoff').text(Settings.cutoff_enabled ? 'Вкл (' + Settings.cutoff_voltage/1000 + ' В)' : 'Выкл');

      const $checkCutoff = $('#checkCutoff');
      const $inputCutoff = $('#inputCutoff');

      if (!$checkCutoff.is(":visible")) {
        if (Settings.cutoff_enabled) {
          if (!$checkCutoff.is( ":checked" )) {
            $checkCutoff.prop('checked', 'checked');
            $('#divCutoff').removeClass('d-none');
          }
        }
        else {
          $checkCutoff.removeProp('checked');
          $('#divCutoff').addClass('d-none');
        }
      }

      if ((!$inputCutoff.is(":visible")) || ($inputCutoff.val() === undefined))
        if (Settings.cutoff_enabled)
          $inputCutoff.val(Settings.cutoff_voltage/1000);

      const $checkBeep = $('#checkBeep');
      if (!$checkBeep.is(":visible")) {
        if (Settings.beeper_enabled) {
          if (!$checkBeep.is( ":checked" )) {
            $checkBeep.prop('checked', 'checked');
          }
        }
        else {
          $checkBeep.removeProp('checked');
        }
      }

      const $checkPLimit = $('#checkPLimit');
      if (!$checkPLimit.is(":visible")) {
        if (Settings.max_power_action) {
          if (!$checkPLimit.is( ":checked" )) {
            $checkPLimit.prop('checked', 'checked');
          }
        }
        else {
          $checkPLimit.removeProp('checked');
        }
      }

      $('#span_point_isActive').text(Point.isActive ? 'Активно' : 'Стоп');
      $('#span_point_vS').text((Point.vS/1000).toFixed(3));
      $('#span_point_Ah').text((Point.mAs/1000/60/60).toFixed(3));
      $('#span_point_Wh').text((Point.mWs/1000/60/60).toFixed(3));
      $('#span_point_iSet').text((Point.iSet/1000).toFixed(2));
      $('#span_point_temp').text((Point.temp/10).toFixed(1));
      $('#span_point_v12').text((Point.v12/1000).toFixed(2));

      if (Point.isActive) {
        if (Point.vS > 0) {
          chart.addData({
            Time: Point.t * 1000,
            Reg: Point.reg,
            Temp: Point.temp / 10,
            V12: Point.v12 / 1000,
            VLoad: Point.vL / 1000,
            VSensor: Point.vS / 1000,
            ISet: Point.iSet / 1000,
            mWs: Point.mWs,
            mAs: Point.mAs
          })

        }
      }

    });
  }

  (function(){
    loadSettings();
    setTimeout(arguments.callee, 1000);
  })();

  $('#btn_loadOn').click(function () {
    $.get("/loadOn", function(data) {
      console.log('Load ON: ' + data);
    })
  })

  $('#btn_loadOff').click(function () {
    $.get("/loadOff", function(data) {
      console.log('Load OFF: ' + data);
    })
  })

  function chartInit(path) {

// Themes begin
    am4core.useTheme(am4themes_animated);
// Themes end

    chart = am4core.create("chartdiv", am4charts.XYChart);
    chart.paddingRight = 20;



    chart.exporting.menu = new am4core.ExportMenu();
    chart.exporting.menu.verticalAlign = "bottom";

    chart.dataSource.url = path;
    chart.dataSource.parser = new am4core.CSVParser();
    chart.dataSource.parser.options.useColumnNames = true;
    chart.dataSource.parser.options.dateFields = ['col0'];
    chart.dataSource.parser.options.dateFormat = 'x';

    chart.dataSource.events.on("parseended", function(ev) {
      // parsed data is assigned to data source's `data` property
      var data = ev.target.data;
      for (var i = 0; i < data.length; i++) {
        data[i]["Temp"] = data[i]["Temp"] / 10;
        data[i]["V12"] = data[i]["V12"] / 1000;
        data[i]["VLoad"] = data[i]["VLoad"] / 1000;
        data[i]["VSensor"] = data[i]["VSensor"] / 1000;
        data[i]["ISet"] = data[i]["ISet"] / 1000;
      }
    });

    console.log(chart.dataSource);

    var dateAxis = chart.xAxes.push(new am4charts.DateAxis());
    dateAxis.renderer.grid.template.location = 0;
    dateAxis.minZoomCount = 5;


// this makes the data to be grouped
    dateAxis.groupData = true;
    dateAxis.groupCount = 100;

    var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());

    seriesVs = chart.series.push(new am4charts.LineSeries());
    seriesVs.dataFields.dateX = "Time";
    seriesVs.dataFields.valueY = "VSensor";
    seriesVs.tooltipText = "{valueY}";
    seriesVs.tooltip.pointerOrientation = "vertical";
    seriesVs.tooltip.background.fillOpacity = 0.5;

    seriesTemp = chart.series.push(new am4charts.LineSeries());
    seriesTemp.dataFields.dateX = "Time";
    seriesTemp.dataFields.valueY = "Temp";
    seriesTemp.tooltipText = "{valueY}";
    seriesTemp.tooltip.pointerOrientation = "vertical";
    seriesTemp.tooltip.background.fillOpacity = 0.5;
    seriesTemp.hidden = true;

    chart.cursor = new am4charts.XYCursor();
    chart.cursor.xAxis = dateAxis;

    var scrollbarX = new am4core.Scrollbar();
    scrollbarX.marginBottom = 20;
    chart.scrollbarX = scrollbarX;
    chart.scrollbarX.exportable = false;


  }

</script>

  </body>
</html>
